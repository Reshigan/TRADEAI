FROM alpine:3.18

# Install required packages
RUN apk add --no-cache \
    mongodb-tools \
    redis \
    aws-cli \
    curl \
    bash \
    dcron \
    && rm -rf /var/cache/apk/*

# Create backup directory
RUN mkdir -p /backups

# Copy backup scripts
COPY backup-mongodb.sh /usr/local/bin/backup-mongodb.sh
COPY backup-redis.sh /usr/local/bin/backup-redis.sh
COPY backup-scheduler.sh /usr/local/bin/backup-scheduler.sh

# Make scripts executable
RUN chmod +x /usr/local/bin/backup-*.sh

# Create cron user
RUN adduser -D -s /bin/bash backup

# Set working directory
WORKDIR /backups

# Health check
HEALTHCHECK --interval=300s --timeout=30s --start-period=60s --retries=3 \
    CMD pgrep crond || exit 1

# Start cron daemon
CMD ["/usr/local/bin/backup-scheduler.sh"]