name: Comprehensive Regression Tests

on:
  pull_request:
    types: [labeled, opened, synchronize]
  schedule:
    - cron: '0 2 * * *'  # Run nightly at 2 AM UTC
  workflow_dispatch:
    inputs:
      company_type:
        description: 'Company type to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - distributor
          - manufacturer
          - retail

jobs:
  regression-test:
    name: Regression - ${{ matrix.company_type }}
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'regression')
    
    strategy:
      fail-fast: false
      matrix:
        company_type: 
          - ${{ github.event.inputs.company_type == 'all' && 'distributor' || github.event.inputs.company_type || 'distributor' }}
          - ${{ github.event.inputs.company_type == 'all' && 'manufacturer' || '' }}
          - ${{ github.event.inputs.company_type == 'all' && 'retail' || '' }}
        exclude:
          - company_type: ''
    
    env:
      RUN_ID: run-${{ github.run_id }}-${{ matrix.company_type }}
      BASE_URL: https://tradeai.gonxt.tech/api
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: backend
        run: npm install --legacy-peer-deps

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run comprehensive regression tests
        run: |
          chmod +x scripts/run-regression.sh
          ./scripts/run-regression.sh ${{ matrix.company_type }} ${{ env.RUN_ID }} ${{ github.run_id }}

      - name: Upload ledger artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ledger-${{ matrix.company_type }}-${{ github.run_id }}
          path: artifacts/ledger/${{ env.RUN_ID }}/
          retention-days: 30

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report-${{ matrix.company_type }}-${{ github.run_id }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test traces
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: traces-${{ matrix.company_type }}-${{ github.run_id }}
          path: test-results/
          retention-days: 30

  summary:
    name: Regression Summary
    runs-on: ubuntu-latest
    needs: regression-test
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Regression Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- Distributor: ${{ needs.regression-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Ledger files: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright reports: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test traces: Available in artifacts (if failed)" >> $GITHUB_STEP_SUMMARY
